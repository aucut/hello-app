import streamlit as st
import pandas as pd
import plotly.graph_objects as go

def calculate_rtp_and_roi(initial_rtp, withdraw_amounts, roi_rate, support_rate, months):
    """
    RTP, ROI ve devlet katkÄ±sÄ± hesaplama fonksiyonu.
    Args:
        initial_rtp (float): Ä°lk ay RTP yatÄ±rÄ±m miktarÄ±.
        withdraw_amounts (list): Her ay iÃ§in geri alÄ±nacak tutar (â‚º).
        roi_rate (float): ROI oranÄ±.
        support_rate (float): Destek oranÄ±.
        months (list): Ay isimleri.
    Returns:
        dict: TÃ¼m hesaplanan deÄŸerleri iÃ§eren tablo.
    """
    num_months = len(months)
    roi_values = [0] * num_months
    support_income = [0] * num_months
    next_rtp_investments = [0] * num_months
    total_earnings = [0] * num_months
    cumulative_withdraw = [0] * num_months

    # Ä°lk ayÄ±n hesaplamalarÄ±
    roi_values[0] = initial_rtp * roi_rate
    support_income[0] = initial_rtp * support_rate
    next_rtp_investments[0] = roi_values[0] - withdraw_amounts[0]
    total_earnings[0] = roi_values[0] + support_income[0]
    cumulative_withdraw[0] = withdraw_amounts[0]

    for i in range(1, num_months):
        roi_values[i] = next_rtp_investments[i - 1] * roi_rate
        support_income[i] = next_rtp_investments[i - 1] * support_rate
        
        if i < 4:
            next_rtp_investments[i] = roi_values[i] - withdraw_amounts[i]
        else:
            next_rtp_investments[i] = roi_values[i] + support_income[i - 4] - withdraw_amounts[i]
        
        total_earnings[i] = roi_values[i] + support_income[i]
        cumulative_withdraw[i] = cumulative_withdraw[i-1] + withdraw_amounts[i]

    return {
        "Aylar": months,
        "ROI MiktarÄ± (â‚º)": [round(x, 2) for x in roi_values],
        "Destek Geliri (â‚º)": [round(x, 2) for x in support_income],
        "Toplam KazanÃ§ (â‚º)": [round(x, 2) for x in total_earnings],
        "Ã‡ekilen Toplam (â‚º)": [round(x, 2) for x in cumulative_withdraw],
        "Sonraki Ay RTP (â‚º)": [round(x, 2) for x in next_rtp_investments]
    }

def create_earnings_chart(results):
    """KazanÃ§ grafiÄŸi oluÅŸturma"""
    fig = go.Figure()
    
    fig.add_trace(go.Bar(
        name='ROI MiktarÄ±',
        x=results["Aylar"],
        y=results["ROI MiktarÄ± (â‚º)"],
        marker_color='rgb(55, 83, 109)'
    ))
    
    fig.add_trace(go.Bar(
        name='Destek Geliri',
        x=results["Aylar"],
        y=results["Destek Geliri (â‚º)"],
        marker_color='rgb(26, 118, 255)'
    ))

    fig.update_layout(
        title='AylÄ±k ROI ve Destek Geliri DaÄŸÄ±lÄ±mÄ±',
        xaxis_title='Aylar',
        yaxis_title='Miktar (â‚º)',
        barmode='group',
        showlegend=True
    )
    
    return fig

def main():
    st.set_page_config(page_title="Dezztech DRS HesaplayÄ±cÄ±", layout="wide")
    
    # BaÅŸlÄ±k ve aÃ§Ä±klama
    st.title("ğŸš€ Dezztech DRS HesaplayÄ±cÄ±")
    st.markdown("""
    Bu araÃ§, RTP yatÄ±rÄ±mlarÄ±nÄ±z iÃ§in:
    - ğŸ“ˆ ROI (YatÄ±rÄ±m Getirisi)
    - ğŸ¦ Devlet DesteÄŸi
    - ğŸ’° Toplam KazanÃ§
    hesaplamalarÄ±nÄ± yapar.
    """)
    
    # Sol sÃ¼tun iÃ§in giriÅŸ alanlarÄ±
    with st.sidebar:
        st.header("ğŸ“Š Hesaplama Parametreleri")
        initial_rtp = st.number_input(
            "Ä°lk Ay RTP YatÄ±rÄ±m MiktarÄ± (â‚º)",
            min_value=0.0,
            value=100000.0,
            step=1000.0,
            format="%,.2f"
        )
        
        roi_rate = st.number_input(
            "ROI OranÄ± (%)",
            min_value=0.0,
            value=150.0,
            step=10.0,
            help="AylÄ±k beklenen ROI oranÄ±"
        ) / 100.0
        
        support_rate = st.number_input(
            "Destek OranÄ± (%)",
            min_value=0.0,
            value=60.0,
            step=5.0,
            help="Devlet destek oranÄ±"
        ) / 100.0
        
        num_months = st.number_input(
            "Hesaplanacak Ay SayÄ±sÄ±",
            min_value=1,
            value=12,
            step=1
        )

    # Ay isimleri
    all_month_names = ["Ocak", "Åubat", "Mart", "Nisan", "MayÄ±s", "Haziran",
                      "Temmuz", "AÄŸustos", "EylÃ¼l", "Ekim", "KasÄ±m", "AralÄ±k"]
    months = [all_month_names[i % 12] for i in range(num_months)]

    # Geri Ã§ekim miktarlarÄ± iÃ§in tablo
    st.subheader("ğŸ“¥ AylÄ±k Geri Ã‡ekim MiktarlarÄ±")
    col1, col2 = st.columns(2)
    withdraw_amounts = []
    
    for i in range(num_months):
        if i % 2 == 0:
            with col1:
                amount = st.number_input(
                    f"{months[i]} ayÄ± Ã§ekim miktarÄ± (â‚º)",
                    min_value=0.0,
                    value=0.0,
                    step=1000.0,
                    key=f"withdraw_{i}",
                    format="%,.2f"
                )
                withdraw_amounts.append(amount)
        else:
            with col2:
                amount = st.number_input(
                    f"{months[i]} ayÄ± Ã§ekim miktarÄ± (â‚º)",
                    min_value=0.0,
                    value=0.0,
                    step=1000.0,
                    key=f"withdraw_{i}",
                    format="%,.2f"
                )
                withdraw_amounts.append(amount)

    # Hesaplama butonu
    if st.button("ğŸ§® Hesapla", use_container_width=True):
        results = calculate_rtp_and_roi(initial_rtp, withdraw_amounts, roi_rate, support_rate, months)
        
        # Grafik gÃ¶sterimi
        st.plotly_chart(create_earnings_chart(results), use_container_width=True)
        
        # SonuÃ§ tablosu
        st.subheader("ğŸ“Š DetaylÄ± SonuÃ§lar")
        df = pd.DataFrame(results)
        st.dataframe(df.style.format({
            "ROI MiktarÄ± (â‚º)": "{:,.2f}",
            "Destek Geliri (â‚º)": "{:,.2f}",
            "Toplam KazanÃ§ (â‚º)": "{:,.2f}",
            "Ã‡ekilen Toplam (â‚º)": "{:,.2f}",
            "Sonraki Ay RTP (â‚º)": "{:,.2f}"
        }), use_container_width=True)
        
        # Ã–zet istatistikler
        col1, col2, col3 = st.columns(3)
        with col1:
            st.metric(
                "Toplam ROI",
                f"â‚º{sum(results['ROI MiktarÄ± (â‚º)']):,.2f}"
            )
        with col2:
            st.metric(
                "Toplam Destek",
                f"â‚º{sum(results['Destek Geliri (â‚º)']):,.2f}"
            )
        with col3:
            st.metric(
                "Toplam Ã‡ekim",
                f"â‚º{results['Ã‡ekilen Toplam (â‚º)'][-1]:,.2f}"
            )

if _name_ == "_main_":
Â Â Â Â main()
